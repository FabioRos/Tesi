\section{Progettazione e codifica}

A partire dalle specifiche fornite dal committente, è stata svolta una accurata analisi per scomporre il questionario di oltre mille domande in questionari di dimensione minore e direttamente correlati alla risorsa di pertinenza.\\
In particolare sono state oggetto di analisi le seguenti componenti:
\begin{itemize}
	\item \textit{Figure di sistema;}
	\item \textit{Dispositivi di protezione individuale;}
	\item \textit{Mansioni;}
	\item \textit{Formazioni;}
	\item \textit{Questionari;}
	\item \textit{Segnalazioni;}
	\item \textit{Procedure;}
	\item \textit{Dispositivi di protezione collettivi.}
\end{itemize}
Per ogni componente, è stato realizzato o restaurato il modello corrispondente, aggiornate le viste che ne facevano uso. Sono state implementate inoltre le regole Drools per verificare la conformità delle informazioni inserite alle norme vigenti in ambito di sicurezza.
\subsection{Riprogettazione delle componenti esistenti}
	
	
\subsubsection{Riprogettazione della componente: \textit{Figure di sistema}}

	Con \textit{figure di sistema} si intendono tutte le cariche che hanno la responsabilità di garantire la sicurezza in azienda. \\
	Come specificato dal testo unico della salute e sicurezza sul lavoro (D.lgs. 81/2008), esse sono: 
	\begin{itemize}
		\item Datore di lavoro;
		\item Dirigente;
		\item Preposto;
		\item Medico Competente;
		\item Responsabile del servizio di prevenzione e Protezione (RSPP);
		\item Addetto al servizio di prevenzione e Protezione (ASPP);
		\item Responsabile dei Lavoratori per la Sicurezza (RLS).
	\end{itemize}
	L'operato delle figure sopra elencate deve essere supervisionato da un \textit{Organo di vigilanza}.

	\paragraph*{Situazione precedente alla riprogettazione} \mbox{} \\
	
	La situazione iniziale prevedeva che la classe \textit{Individual} avesse  un attributo booleano per ogni tipologia di figura di sistema. \\
	\hl{Si è resa necessaria una riprogettazione} dal momento che alcune figure dovevano ricoprire lo stesso ruolo contemporaneamente in più contesti e questa situazione non poteva essere gestita con l'architettura esistente. \\
	Un esempio di tale problema è rappresentato da un ASPP assegnato a due cantieri contemporaneamente. Tale situazione si può verificare se i due cantieri sono allocati nello stesso periodo e nel primo si lavora il mattino, mentre nel secondo di pomeriggio oppure a giorni alterni.\\
	I questionari relativi a a tutte le figure di sistema erano presentati in una pagina contenente tutte le domande. I problemi che tale soluzione procurava erano sostanzialmente due: era possibile gestire al più un individuo per ogni ruolo e le domande a cui rispondere in una sola sezione erano più di centocinquanta.

	\paragraph*{Modifiche apportate}\mbox{} \\
	L'architettura è stata riprogettata centralizzando tutti i ruoli in una apposita classe \texttt{Role} e Mantenendo la relazione molti a molti mediante una tabella intermedia \texttt{IndividualRoles}. \\
	Questo approccio si è rivelato molto vantaggioso perché ha permesso di associare ogni classe rappresentante un ruolo, alle formazioni minime che un individuo deve possedere per poter ricoprire quella carica. \\
	Questa soluzione (\autoref{fig:DiagrammaDelleClassiIndividualRoles}) soddisfa appieno tutti ri requisiti.\\
		\begin{figure}[H]
			\begin{center}
				\includegraphics[width=12cm]{Pics/UMLClassiFigureDiSistema.png}
				\caption{
					Diagramma delle classi per la gestione delle figure di sistema ed i relativi questionari.}
				\label{fig:DiagrammaDelleClassiIndividualRoles}
			\end{center}
		\end{figure}
	Obiettivo primario del\hl{la riprogettazione} è stato centralizzare tutte le informazioni relative alle figure di sistema ed i loro questionari in un unica sezione. 
	La schermata presente nella  \autoref{fig:ScreenPrincipaleFigureDiSistema} vuole rappresentare il risultato del lavoro svolto per le figure riguardanti l'azienda. \\
		\begin{figure}[H]
			\begin{center}
				\includegraphics[width=12cm]{Pics/ScreenFigureDiSistemaProspetto.png}
				\caption{
					Schermata iniziale della sezione \textit{Figure di sistema}.}
				\label{fig:ScreenPrincipaleFigureDiSistema}
			\end{center}
		\end{figure}
	È stato implementato inoltre un pannello dedicato alla gestione delle figure impiegate in specifiche sedi o cantieri. In questo modo è sempre possibile allocare gli individui nei luoghi d'interesse senza vincoli di molteplicità.\\
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=12cm]{Pics/ScreenfigureDiCantiere.png}
			\caption{
				Schermata iniziale della sezione \textit{Pannnello di gestione delle figure impegnate in sedi e cantieri.}.}
			\label{fig:ScreenPrincipaleFigureSediCantieri}
		\end{center}
	\end{figure}

	Per facilitare l'inserimento delle informazioni relative alla selezione dei dipendenti, è stata utilizzata la libreria \textit{Selectize.js} per rendere i form più gradevoli dal punto di vista grafico e per permettere l'autocompletamento (vedi \autoref{fig:ScreenOrganodiVigilanza} ). \\ 
	Una criticità si è presentata nell'inserimento dinamico delle figure che possono essere presenti con molteplicità maggiore di uno. In particolare gli RSPP e gli ASPP presentano l'ulteriore complicazione rappresentata dal fatto che possono essere sia membri interni all'azienda, sia esterni. \\
	In entrambi i casi, la situazione è stata gestita mediante chiamate \gls{Ajax}, evitando quindi di dover ricaricare la pagina ad ogni inserimento e generando un record della classe \textit{Individual}  identificato da un particolare flag (\texttt{is\_external}) nel caso si tratti di una figura esterna all'azienda.\\
	
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=11cm]{Pics/screen_organo_di_vigianza_con_autocompletamento.png}
			\caption{
				Schermata relativa all'inserimento di alcune informazioni in merito all'organo di vigilanza}
			\label{fig:ScreenOrganodiVigilanza}
		\end{center}
	\end{figure}
	
	Ad ogni figura di sistema è stato associato un questionario nel quale sono specificate le informazioni in merito alla carica, tra tutte la data di accettazione e scadenza dell''incarico.
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=12cm]{Pics/RemoteTrueRSPP.png}
			\caption{
				Schermata relativa all'inserimento di un RSPP.}
			\label{fig:ScreenRSPP}
		\end{center}
	\end{figure}	
	  L'associazione ad un questionario avviene generando tutte le risposte ad esso relative.\\
	  Per ogni risposta saranno preimpostati i seguenti valori:
	  \begin{itemize}
		  \item \texttt{response:} \texttt{nil};
		  \item \texttt{answerable\_type:} \texttt{"IndividualRoles"};
		  \item \texttt{answerable\_id:} codice identificativo dell'istanza specifica di \texttt{"IndividualRoles"}.
	  \end{itemize}

	Facendo Riferimento alla \autoref{fig:ScreenRSPP} e  supponendo che \textit{Aldo Bianchi} non sia attualmente presente nel database, alla pressione del tasto invio verrà generato un nuovo \textit{Individual} relativo ad \textit{Aldo Bianchi}. Successivamente verrà generato un questionario con le domande relative agli RSPP in relazione ad \textit{Aldo Bianchi}.
	
\newpage
\subsubsection{Riprogettazione della componente: \textit{DPI}}
\hl{nuova sezione}
Il termine \textit{DPI} è un acronimo di \textit{Dispositivi di Protezione Individuale}. \\
Appartengono a questa categoria tutti i dispositivi utilizzati per la prevenzione degli infortuni dei lavoratori ad esempio guanti, occhiali e caschetti.\\

\paragraph*{Situazione precedente alla riprogettazione} \mbox{} \\
Al momento dell'arrivo in azienda, la situazione presente era la seguente:
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=10cm]{Pics/UMLClassiDPIversioneAllArrivo.png}
			\caption{
			Diagramma delle classi relativo ai DPI all'inizio dello stage .}
			\label{fig:UMLClassiDPIversioneAllArrivo}
		\end{center}
	\end{figure}


Come si può osservare dalla \autoref{fig:UMLClassiDPIversioneAllArrivo}, questa soluzione non impone vincoli sul nome del \gls{DPI}\G.
È necessario però segnalare se un utente non è in possesso tutti i \gls{DPI}\G\ necessari allo svolgimento di una data mansione.\\
Questa soluzione necessitava di essere restaurata poiché, non imponendo vincoli sul nome, rende impossibile gestire il caso sopracitato poiché lo stesso \gls{DPI}\G\ può essere descritto utilizzando stringhe diverse.\\
Il questionario relativo ai \gls{DPI}\G\ era stato implementato riportando tutte le domande in un unico blocco, senza differenziare le domande relative ad uno specifico \gls{DPI}\G\ da quelle generiche sui \gls{DPI}\G.

\paragraph*{Modifiche apportate}\mbox{} \\
Le modifiche hanno coinvolto sia il \gls{back-end}\G\ sia  il  \gls{front-end}\G\ dell'applicazione. \\
In particolare, nel  \gls{back-end}\G\ sono stati centralizzati i nomi dei \gls{DPI} in un unica classe. \\ 
Questa soluzione risolve il problema dell'impossibilità di riconoscimento del \gls{DPI}\G\ perché il nome è rappresentato da un riferimento ad una lista di possibili valori definiti nel pannello di amministrazione. \\
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=14cm]{Pics/UMLClassiDPIRiprogettato.png}
		\caption{Diagramma delle classi relativo ai DPI dopo la riprogettazione.}
		\label{fig:UMLClassiDPIriprogettato}
	\end{center}
\end{figure}

Dopo un'attenta analisi, è stata rivista tutta l'organizzazione delle domande relative ai \gls{DPI}\G.\\
In particolare sono stati differenziate le domande relative ad uno specifico \gls{DPI}\G\ da quelle generali in merito alla gestione dei \gls{DPI}\G\ in azienda.\\
Lato \gls{front-end}\G, è stato reso possibile, per un utente amministratore, la gestione delle tipologie dei \gls{DPI}\G\ da pannello di controllo. Questo passaggio è stato reso estremamente semplice e veloce da implementare dall'utilizzo della gemma \hyperref[sec:ActiveAdmin]{ActiveAdmin} di Ruby on Rails.
\newpage
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=12cm]{Pics/ActiveAdminDPI}
		\caption{Schermata relativa alla digestione dei DPI nel pannello di amministrazione.}
		\label{fig:ActiveAdminDPI}
	\end{center}
\end{figure}

E'\ stata completamente riprogettata l'interfaccia relativa alla gestione dei \gls{DPI}\G\ assegnabili ad un dipendente.\\
In particolare è stato inserito un questionario a scomparsa contenente le domande relative alla formazione obbligatoria del datore di lavoro. \\
L'input dei \gls{DPI}\G\ è stato facilitato mediante autocompletamento basato sui record della tabella \texttt{DpisName} .
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=12cm]{Pics/ScreenDPI.png}
		\caption{Schermata relativa alla digestione dei DPI nell'interfaccia utente.}
		\label{fig:ScreenDPI}
	\end{center}
\end{figure}

\newpage
\subsubsection{Riprogettazione di mansioni e formazioni}
\hl{nuova sezione}\\
Uno degli aspetti cardine del progetto è stato la gestione della relazione che intercorre tra le mansioni che svolge un dipendente e le formazioni di cui è in possesso.\\
Questa funzionalità ha richiesto una riprogettazione delle classi relative a formazioni e mansioni oltre alla definizione delle regole relative.\\


\paragraph*{Situazione precedente alla riprogettazione} \mbox{} \\
	Al momento dell'inizio dello stage, le mansioni e le formazioni erano delle classi con una chiave esterna verso la classe \texttt{Employee} che rappresenta il dipendente in possesso di quella formazione oppure a cui è stata affidata quella mansione.\\
	Anche in questo caso, la descrizione era gestita con un campo testuale provocando ambiguità nel riconoscimento di una specifica mansione o formazione.\\
	La gestione lato \gls{front-end}\G\ era poco intuitiva poiché solo abbozzata.
	
\paragraph*{Modifiche apportate} \mbox{} \\
\hl{scrivere meglio e completare}\\

Le mansioni e le formazioni sono state riprogettate allo stesso modo dei \gls{DPI}\G, ovvero centralizzando la definizione del nome in una tabella definita allo scopo. \\
Per evitare di affaticare la lettura non verranno trattati i dettagli implementativi relativi alle singole componenti. \\
Risulta invece degna di nota l'integrazione tra le due componenti finalizzata alla verifica della presenza delle formazioni necessarie allo svolgimento di una mansione. \\

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=12cm]{Pics/UMLClassiFormazioniMansioni.png}
		\caption{Diagramma delle classi di formazioni, mansioni e della relazione tra esse.}
		\label{fig:UMLClassiFormazioniMansioni.png}
	\end{center}
\end{figure}

Come è possibile osservare dalla \autoref{fig:UMLClassiFormazioniMansioni.png}, ogni record della tabella \texttt{DutyNeedsTraining} contiene un riferimento alla classe \texttt{Training} ed uno alla classe \texttt{Duty}.\\
Ogni coppia identifica una relazione che, se non soddisfatta per qualche dipendente, solleverà un allarme ad esso associato.\\
Un aspetto critico è stato dare la possibilità ad un utente amministratore di definire le regole di dipendenza tra mansioni e formazioni in modo autonomo. \\
La tabella \texttt{DutyNeedsTraining}, introdotta per mappare le dipendenze, è stata utilizzata per generare una regola relativa la verifica della conformità tra relazioni e formazioni. La regola appena descritta è riportata nella \autoref{Drools:regolaMansioniFormazioni}.
La gestione dal pannello di controllo  stata realizzata utilizzando la gemma \hyperref[sec:ActiveAdmin]{ActiveAdmin}, rendendo  autonomo l'utilizzatore finale nella gestione delle relazioni necessità tra mansioni e formazioni.
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=14cm]{Pics/ScreenFormazioneMansioneAdmin.png}
		\caption{Schermata relativa alla digestione delle formazioni necessarie allo svolgimento di determinate mansioni.}
		\label{fig:ScreenFormazioneMansioneAdmin.png}
	\end{center}
\end{figure}
Per un utente autenticato, l'immissione delle mansioni e delle formazioni dei dipendenti avviene allo stesso modo dei \gls{DPI}\G. Eventuali non conformità sulle formazioni in possesso di un dipendente in relazione alla mansione che svolge saranno segnalate con un allarme. \\
 Questo approccio sposa la filosofia generale del progetto la quale prevede che deve essere sempre possibile inserire i dati senza blocchi dettati dai vincoli di legge, in modo da evidenziare eventuali non conformità con allarmi al fine di risolverle.
\newpage
\subsubsection{Restyling della componente: \textit{Questionari}}
I questionari sono stati riprogettati solo lato \gls{front-end}\G.
Al momento dell'arrivo in azienda, le domande venivano poste in sequenza organizzate in capitoli. Questo approccio rischia di disorientare l'utente poiché al crescere del numero delle domande può trovare difficoltà nel ricordare quale sia il capitolo in questione. \\
Per ovviare a questo problema, tutte le domande sono state inserite  in un accordion e bloccando il titolo in alto durante lo scroll. In questo modo, all'apertura della pagina sono facilmente visibili i capitoli e, durante la compilazione del questionario, il titolo del capitolo è sempre visibile.\\

\begin{figure}[H]
	\begin{center}
		\includegraphics[width=12.6cm]{Pics/ScreenQuestionarioSediApertura.png}
		\caption{Schermata relativa al questionario relativo alla sicurezza nelle sedi al momento dell'apertura.}
		\label{fig:ScreenQuestionarioSediApertura.png}
	\end{center}
\end{figure}
Nella figura seguente si può notare il fatto che il titolo del capitolo rimane sempre visibile quando l'accordion è aperto.\\
\begin{figure}[H]
	\begin{center}
		\includegraphics[width=12cm]{Pics/ScreenQuestionarioStickyHeader.png}
		\caption{Schermata relativa al questionario relativo alla sicurezza nelle sedi al momento della risposta ad una domanda.}
		\label{fig:ScreenQuestionarioStickyHeader.png}
	\end{center}
\end{figure}

 


\newpage
\subsection{Nuove componenti}
Le componenti descritte di seguito, sono state progettate e implementate nella loro interezza durante lo stage.\\
\hl{TODO Scrivere di più nell'introduzione}

\subsubsection{\textit{Segnalazioni}}
Le segnalazioni sono delle comunicazioni inviate da un qualunque membro interno all'azienda ed indirizzate verso l'organo di vigilanza.\\
Le segnalazioni hanno lo scopo di sollevare il responsabile dalle responsabilità derivanti da violazioni avvenute sotto la sua supervisione. \\
Le comunicazioni all'organo di vigilanza infatti, non possono essere anonime e demandano ufficialmente la responsabilità delle eventuali violazioni a tale organo il quale dovrà decidere per eventuali azioni correttive.
	
	\paragraph*{Progettazione}\mbox{} \\
	Come è possibile osservare dalla \autoref{fig:UMLClassiSegnalazioni}, le segnalazioni sono state implementate come una classe (\texttt{Report}) con una chiave esterna verso la classe \texttt{Individual}. \\
	La presenza del riferimento verso un'istanza della classe \texttt{Individual} è obbligatoria, soddisfacendo quindi il vincolo di non anonimato delle segnalazioni.\\
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=12cm]{Pics/UMLClassiSegnalazioni.png}
			\caption{Diagramma delle classi relativo alle segnalazioni.}
			\label{fig:UMLClassiSegnalazioni}
		\end{center}
	\end{figure}
	Specifiche direttive del committente hanno richiesto l'inserimento di tre date rilevanti al fine della gestione delle segnalazioni:
	\begin{itemize}
		\item \textit{Data di invio della segnalazione all'alta direzione;}
		\item \textit{Data di invio della segnalazione dall'alta direzione all'organo di vigilanza;}
		\item \textit{Data di invio della risposta alla segnalazione da parte dell'organo di vigilanza al soggetto interessato.}
	\end{itemize}
	In accordo con la filosofia del progetto, sono state gestite la presenza e sequenzialità delle date con degli allarmi in caso di errato inserimento.\\
	Per facilitare la gestione delle segnalazioni, nell'interfaccia utente relativa ad esse sono riportate tutte le date. Questo approccio permette di tenere sempre traccia dello stato delle segnalazioni ed agevola la verifica da parte delle autorità competenti.\\
	Uno sviluppo futuro, prevede l'archiviazione delle segnalazioni le quali hanno data di invio della risposta alla segnalazione da parte dell'organo di vigilanza al soggetto interessato più vecchia di 30 giorni. Questa soluzione è stata progettata ma non implementata nel periodo di stage a causa dell'esaurimento del monte ore disponibile.
	\begin{figure}[H]
		\begin{center}
			\includegraphics[width=12cm]{Pics/ScreenSegnalazioni.png}
			\caption{Schermata relativa alla gestione delle segnalazioni.}
			\label{fig:ScreenSegnalazioni}
		\end{center}
	\end{figure}
\newpage
\subsubsection{\textit{Procedure}}

	\paragraph{Progettazione}
	\paragraph{Criticità incontrate}
		%più controller e viste associate allo stessa categoria, uno ha il modello l'altro il questionario
\newpage
\subsubsection{\textit{Dispositivi di protezione collettivi}}

	\paragraph{Progettazione}
	\paragraph{Criticità incontrate}
		%remote true
		

\newpage
\subsection{Regole Drools}
\label{Drools:regole}
\hl{In questa sezione vengono riportate alcune tra le regole Drools più significative.}
	\label{Drools:regolaMansioniFormazioni}
	\begin{verbatim}
	rule "Individuo ricopre una mansione per la quale non è formato"
	when
	$t: Training()
	$d: Duty(trainings contains $t)
	$i: Individual(duties contains $d, trainings not contains $t)
	then
	System.out.println($i.getFirstName() + ' ' + $i.getLastName() + "ha la mansione" +
	$d.getName() + " ma non la formazione " + $t.getName() );
	end
	\end{verbatim}
	\begin{itemize}
		\item \$t contiene tutte le formazioni;
		\item \$d contiene  tutte le mansioni che necessitano della formazione \$t;
		\item \$i contiene tutti gli individui che svolgono la mansione \$d ma non sono in possesso della formazione \$t.
	\end{itemize}
	Le corrispondenze di questa regola sono tutti gli individui individui che svolgono una qualunque mansione per la quale non sono correttamente formati.\\
	Al verificarsi di queste condizioni, viene generato un allarme il cui contenuto è specificato dalla stampa disposta dalla \gls{RHS}\G.
	
	%{TODO regole su: CPI con superficie > N mq}



\newpage
\section{Verifica e validazione}
\newpage
\section{Considerazioni finali}
	Al termine dello stage sono stati analizzati i risultati ottenuti e sul valore aggiunto che esso ha portato.\\
	\hl{TODO }	

























